import json
from typing import Dict, List, Any
from openai import AsyncOpenAI
from bson import ObjectId

from ..config import settings

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = AsyncOpenAI(
    api_key=settings.OPENAI_API_KEY
)

def debug_print_animation(silhouette_animation: Dict, exercise_name: str):
    """ìƒì„±ëœ ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„°ë¥¼ ì¶œë ¥í•˜ì—¬ í™•ì¸"""
    print(f"\n{'='*60}")
    print(f"ğŸ¬ [{exercise_name}] ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„° í™•ì¸")
    print(f"{'='*60}")
    
    keyframes = silhouette_animation.get("keyframes", [])
    print(f"ğŸ“Š ì´ í‚¤í”„ë ˆì„ ìˆ˜: {len(keyframes)}")
    
    if len(keyframes) > 0:
        print(f"\nğŸ” ì²« ë²ˆì§¸ í‚¤í”„ë ˆì„:")
        first_frame = keyframes[0]
        print(f"  - timestamp_ms: {first_frame.get('timestamp_ms')}")
        print(f"  - description: {first_frame.get('description')}")
        print(f"  - ëœë“œë§ˆí¬ ìˆ˜: {len(first_frame.get('pose_landmarks', []))}")
        
        # ì£¼ìš” ê´€ì ˆ ìœ„ì¹˜ í™•ì¸
        landmarks = first_frame.get('pose_landmarks', [])
        if len(landmarks) >= 33:
            print(f"\nğŸ“ ì£¼ìš” ê´€ì ˆ ìœ„ì¹˜ (ì²« ë²ˆì§¸ í”„ë ˆì„):")
            print(f"  - ì½”(0): x={landmarks[0]['x']:.3f}, y={landmarks[0]['y']:.3f}")
            print(f"  - ì™¼ìª½ ì–´ê¹¨(11): x={landmarks[11]['x']:.3f}, y={landmarks[11]['y']:.3f}")
            print(f"  - ì˜¤ë¥¸ìª½ ì–´ê¹¨(12): x={landmarks[12]['x']:.3f}, y={landmarks[12]['y']:.3f}")
            print(f"  - ì™¼ìª½ ì—‰ë©ì´(23): x={landmarks[23]['x']:.3f}, y={landmarks[23]['y']:.3f}")
            print(f"  - ì™¼ìª½ ë¬´ë¦(25): x={landmarks[25]['x']:.3f}, y={landmarks[25]['y']:.3f}")
            print(f"  - ì™¼ìª½ ë°œëª©(27): x={landmarks[27]['x']:.3f}, y={landmarks[27]['y']:.3f}")
    
    if len(keyframes) > 1:
        print(f"\nğŸ” ë‘ ë²ˆì§¸ í‚¤í”„ë ˆì„:")
        second_frame = keyframes[1]
        print(f"  - timestamp_ms: {second_frame.get('timestamp_ms')}")
        print(f"  - description: {second_frame.get('description')}")
        
        landmarks = second_frame.get('pose_landmarks', [])
        if len(landmarks) >= 33:
            print(f"\nğŸ“ ì£¼ìš” ê´€ì ˆ ìœ„ì¹˜ (ë‘ ë²ˆì§¸ í”„ë ˆì„):")
            print(f"  - ì½”(0): x={landmarks[0]['x']:.3f}, y={landmarks[0]['y']:.3f}")
            print(f"  - ì™¼ìª½ ë¬´ë¦(25): x={landmarks[25]['x']:.3f}, y={landmarks[25]['y']:.3f}")
    
    print(f"{'='*60}\n")

# --- ê¸°ì¡´ ë‹¨ì¼ ìš´ë™ ìƒì„± í•¨ìˆ˜ (guide_poses ì¶”ê°€) ---
async def generate_personalized_exercise(
    user_body_condition: Dict,
    exercise_type: str,
    intensity: str,
    duration_minutes: int,
    db
) -> Dict[str, Any]:
    """
    ì‚¬ìš©ì ì‹ ì²´ ìƒíƒœ ê¸°ë°˜ AI ë§ì¶¤ ìš´ë™ ìƒì„± (ë‹¨ì¼)
    """
    
    # âœ… 1. OpenAI API í˜¸ì¶œ ì¶”ê°€
    prompt = create_exercise_prompt(user_body_condition, {}, exercise_type, intensity, duration_minutes)
    
    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì¬í™œ ìš´ë™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤."},
                {"role": "user", "content": prompt}
            ],
            response_format={"type": "json_object"},
            temperature=0.7,
            max_tokens=2000
        )
        
        content = response.choices[0].message.content
        if content.strip().startswith("```json"):
            content = content.strip()[7:-3]
        
        exercise_data = json.loads(content)
        
    except Exception as e:
        print(f"âŒ OpenAI API ì˜¤ë¥˜: {e}")
        exercise_data = {
            "name": "ê¸°ë³¸ ì¬í™œ ìš´ë™",
            "description": "ì•ˆì „í•œ ê¸°ë³¸ ìš´ë™ì…ë‹ˆë‹¤.",
            "instructions": ["ì²œì²œíˆ ì‹œì‘í•˜ì„¸ìš”", "í†µì¦ì´ ìˆìœ¼ë©´ ë©ˆì¶”ì„¸ìš”"],
            "repetitions": 10,
            "sets": 3,
            "target_parts": ["ì „ì‹ "],
            "safety_warnings": ["ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”"]
        }
    
    exercise_name = exercise_data.get("name", "ê¸°ë³¸ ìš´ë™")
    
    # âœ… 2. base_template ê°€ì ¸ì˜¤ê¸°
    base_template = await get_base_template(db, exercise_type, user_body_condition)
    if not base_template:
        base_template = await create_default_template(exercise_name)
    
    # âœ… 3. guide_poses ìƒì„± (await ì¶”ê°€)
    guide_poses = await generate_guide_poses(exercise_name)
    print(f"âœ… [{exercise_name}] guide_poses ìƒì„±: {len(guide_poses)}ê°œ í”„ë ˆì„")
    
    # âœ… 4. silhouette_animation ìƒì„±
    silhouette_animation = generate_silhouette_from_guide_poses(
        guide_poses=guide_poses,
        duration_seconds=duration_minutes * 60,
        intensity=intensity
    )
    
    print(f"âœ… silhouette_animation ìƒì„± ì™„ë£Œ: {len(silhouette_animation.get('keyframes', []))}ê°œ í‚¤í”„ë ˆì„")

    # âœ… 5. ìµœì¢… ìš´ë™ ë°ì´í„° ë°˜í™˜
    final_exercise = {
        "base_template_id": base_template.get("_id"),
        "name": exercise_data.get("name", "ë§ì¶¤ ì¬í™œ ìš´ë™"),
        "description": exercise_data.get("description", "ì‚¬ìš©ì ì‹ ì²´ ìƒíƒœì— ë§ì¶˜ ìš´ë™ì…ë‹ˆë‹¤."),
        "instructions": exercise_data.get("instructions", ["ì¤€ë¹„ ìì„¸ë¥¼ ì·¨í•˜ì„¸ìš”", "ì²œì²œíˆ ë™ì‘ì„ ìˆ˜í–‰í•˜ì„¸ìš”"]),
        "duration_seconds": duration_minutes * 60,
        "repetitions": exercise_data.get("repetitions", 10),
        "sets": exercise_data.get("sets", 3),
        "target_parts": exercise_data.get("target_parts", ["ì „ì‹ "]),
        "safety_warnings": exercise_data.get("safety_warnings", ["í†µì¦ì´ ëŠê»´ì§€ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”"]),
        "silhouette_animation": silhouette_animation,
        "guide_poses": guide_poses,
        "customization_params": {
            "intensity": intensity,
            "speed_multiplier": get_speed_multiplier(intensity),
            "rom_adjustment": get_rom_adjustment(user_body_condition),
            "hold_time_ms": get_hold_time(intensity)
        }
    }
    return final_exercise
# --- ì¶”ì²œ ìš´ë™ ìƒì„± í•¨ìˆ˜ (guide_poses + ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ ì¶”ê°€) ---

def create_recommendations_prompt(user_body_condition: Dict, exclude_exercises: List[str] = None) -> str:
    """
    OpenAI APIìš© í”„ë¡¬í”„íŠ¸ ìƒì„± (ì—¬ëŸ¬ ìš´ë™ ì¶”ì²œìš©)
    âœ… ìˆ˜ì •: instructions, safety_warnings, target_parts ì¶”ê°€ ìš”ì²­
    âœ… ì¶”ê°€: exclude_exercisesë¡œ ì´ì „ ìš´ë™ ì œì™¸
    """
    injured_parts = user_body_condition.get("injured_parts", [])
    pain_level = user_body_condition.get("pain_level", 0)
    limitations = user_body_condition.get("limitations", [])
    
    # âœ… ì œì™¸í•  ìš´ë™ ë¦¬ìŠ¤íŠ¸
    exclude_text = ""
    if exclude_exercises and len(exclude_exercises) > 0:
        exclude_text = f"\n\n**ì¤‘ìš”: ë‹¤ìŒ ìš´ë™ë“¤ì€ ì´ë¯¸ ì¶”ì²œí–ˆìœ¼ë¯€ë¡œ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”:**\n- {', '.join(exclude_exercises)}\n**ë°˜ë“œì‹œ ìƒˆë¡­ê³  ë‹¤ë¥¸ ìš´ë™ì„ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤!**"

    return f"""
ë‹¤ìŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë§ì¶¤ ì¬í™œ ìš´ë™ **3ê°€ì§€**ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”.
ì‘ë‹µì€ ë°˜ë“œì‹œ 'recommendations'ë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ ë‹¨ì¼ JSON ê°ì²´ì—¬ì•¼ í•˜ë©°, ê° ì¶”ì²œ ìš´ë™ì€ ë¦¬ìŠ¤íŠ¸ì˜ ìš”ì†Œë¡œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

**ì‚¬ìš©ì ì •ë³´:**
- ë¶€ìƒ ë¶€ìœ„: {', '.join(injured_parts) if injured_parts else 'ì—†ìŒ'}
- í†µì¦ ìˆ˜ì¤€ (0-10): {pain_level}
- ì›€ì§ì„ ì œí•œ ì‚¬í•­: {', '.join(limitations) if limitations else 'ì—†ìŒ'}{exclude_text}

**ìƒì„±í•  JSON í˜•ì‹:**
{{
  "recommendations": [
    {{
      "name": "ì¶”ì²œ ìš´ë™ 1 ì´ë¦„ (ì˜ˆ: ë²½ ëŒ€ê³  ì²œì²œíˆ ìŠ¤ì¿¼íŠ¸)",
      "description": "ì´ ìš´ë™ì´ ì™œ ì‚¬ìš©ìì—ê²Œ ì¢‹ì€ì§€ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (1-2 ë¬¸ì¥)",
      "instructions": [
        "1ë‹¨ê³„: ì‹œì‘ ìì„¸ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (ì˜ˆ: ë²½ì—ì„œ 30cm ë–¨ì–´ì ¸ ì„œì„¸ìš”)",
        "2ë‹¨ê³„: ìš´ë™ ë™ì‘ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (ì˜ˆ: ë¬´ë¦ì„ ì²œì²œíˆ êµ¬ë¶€ë¦¬ë©° ì•‰ìœ¼ì„¸ìš”)",
        "3ë‹¨ê³„: í˜¸í¡ë²• ë˜ëŠ” ì£¼ì˜ì‚¬í•­ (ì˜ˆ: ìˆ¨ì„ ë‚´ì‰¬ë©° ì²œì²œíˆ ì¼ì–´ë‚˜ì„¸ìš”)",
        "4ë‹¨ê³„: ë§ˆë¬´ë¦¬ ë™ì‘ (ì˜ˆ: ì‹œì‘ ìì„¸ë¡œ ëŒì•„ì™€ ì ì‹œ íœ´ì‹í•˜ì„¸ìš”)"
      ],
      "safety_warnings": [
        "ë¬´ë¦ì´ ë°œëì„ ë„˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”",
        "í†µì¦ì´ ëŠê»´ì§€ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”",
        "ì²œì²œíˆ ì›€ì§ì´ë©° ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”"
      ],
      "target_parts": ["ë¬´ë¦", "í—ˆë²…ì§€", "ì—‰ë©ì´"],
      "duration_minutes": 10,
      "intensity": "low",
      "sets": 3,
      "repetitions": 8,
      "recommendation_reason": "ì‚¬ìš©ìì˜ '{", ".join(injured_parts) if injured_parts else "ëª¸"}' ìƒíƒœë¥¼ ê³ ë ¤í–ˆì„ ë•Œ, ì´ ìš´ë™ì€ [êµ¬ì²´ì ì¸ ì´ìœ ] ë•Œë¬¸ì— ì¶”ì²œí•©ë‹ˆë‹¤."
    }},
    {{
      "name": "ì¶”ì²œ ìš´ë™ 2 ì´ë¦„ (ì˜ˆ: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ ë»—ê¸°)",
      "description": "...",
      "instructions": ["1ë‹¨ê³„: ...", "2ë‹¨ê³„: ...", "3ë‹¨ê³„: ...", "4ë‹¨ê³„: ..."],
      "safety_warnings": ["ì£¼ì˜ì‚¬í•­1", "ì£¼ì˜ì‚¬í•­2", "ì£¼ì˜ì‚¬í•­3"],
      "target_parts": ["ë¶€ìœ„1", "ë¶€ìœ„2"],
      "duration_minutes": 15,
      "intensity": "low",
      "sets": 3,
      "repetitions": 12,
      "recommendation_reason": "..."
    }},
    {{
      "name": "ì¶”ì²œ ìš´ë™ 3 ì´ë¦„ (ì˜ˆ: í¼ë¡¤ëŸ¬ í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­)",
      "description": "...",
      "instructions": ["1ë‹¨ê³„: ...", "2ë‹¨ê³„: ...", "3ë‹¨ê³„: ...", "4ë‹¨ê³„: ..."],
      "safety_warnings": ["ì£¼ì˜ì‚¬í•­1", "ì£¼ì˜ì‚¬í•­2", "ì£¼ì˜ì‚¬í•­3"],
      "target_parts": ["ë¶€ìœ„1", "ë¶€ìœ„2"],
      "duration_minutes": 5,
      "intensity": "stretching",
      "sets": 2,
      "repetitions": 1,
      "recommendation_reason": "..."
    }}
  ]
}}

**ì¤‘ìš” ì§€ì¹¨:**
1.  **3ê°œì˜ ìš´ë™**ì„ ë°˜ë“œì‹œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
2.  ìš´ë™ ê°•ë„(intensity)ëŠ” 'low', 'medium', 'high', 'stretching' ì¤‘ì—ì„œ ì„ íƒí•˜ì„¸ìš”.
3.  **instructionsëŠ” ë°˜ë“œì‹œ 3-4ê°œì˜ êµ¬ì²´ì ì¸ ë‹¨ê³„**ë¡œ ì‘ì„±í•˜ì„¸ìš” (ì‹œì‘ ìì„¸ â†’ ìš´ë™ ë™ì‘ â†’ í˜¸í¡/ì£¼ì˜ â†’ ë§ˆë¬´ë¦¬).
4.  **safety_warningsëŠ” ë°˜ë“œì‹œ 2-3ê°œì˜ êµ¬ì²´ì ì¸ ì£¼ì˜ì‚¬í•­**ì„ ì‘ì„±í•˜ì„¸ìš”.
5.  **target_partsëŠ” ì‹¤ì œ ìš´ë™í•˜ëŠ” ì‹ ì²´ ë¶€ìœ„**ë¥¼ ì •í™•í•˜ê²Œ ë‚˜ì—´í•˜ì„¸ìš” (ì˜ˆ: ë¬´ë¦, í—ˆë²…ì§€, ì—‰ë©ì´, ì–´ê¹¨, ë“±).
6.  `recommendation_reason`ì€ ì‚¬ìš©ì ì •ë³´ì™€ ìš´ë™ì„ ì—°ê²°í•˜ì—¬ ë§¤ìš° êµ¬ì²´ì ì´ê³  ì„¤ë“ë ¥ ìˆê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
7.  ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
8.  ê° ìš´ë™ì€ ì„œë¡œ ë‹¤ë¥¸ ì¢…ë¥˜ì—¬ì•¼ í•˜ë©°, ë‹¤ì–‘ì„±ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.
"""

async def generate_exercise_recommendations(
    user_body_condition: Dict, 
    exclude_exercises: List[str] = None
) -> List[Dict[str, Any]]:
    """
    AIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì—¬ëŸ¬ ë§ì¶¤ ìš´ë™ì„ ì¶”ì²œ
    âœ… ìˆ˜ì •: guide_poses ìƒì„± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í¬ì¦ˆ ì‚¬ìš©
    """
    if not user_body_condition:
        return []

    prompt = create_recommendations_prompt(user_body_condition, exclude_exercises)

    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì¬í™œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. JSON í˜•ì‹ìœ¼ë¡œ 3ê°œì˜ ìš´ë™ì„ ì¶”ì²œí•˜ì„¸ìš”."},
                {"role": "user", "content": prompt}
            ],
            response_format={"type": "json_object"},
            temperature=0.8,
            max_tokens=3000
        )
        
        content = response.choices[0].message.content
        if content.strip().startswith("```json"):
            content = content.strip()[7:-3]
            
        result = json.loads(content)
        recommendations = result.get("recommendations", [])
        
        print(f"\nğŸ¯ ì¶”ì²œ ìš´ë™ {len(recommendations)}ê°œ ìƒì„±ë¨")
        
        # âœ… ê° ì¶”ì²œ ìš´ë™ì— guide_posesì™€ silhouette_animation ì¶”ê°€
        for idx, rec in enumerate(recommendations):
            exercise_name = rec.get("name", "ê¸°ë³¸ ìš´ë™")
            intensity = rec.get("intensity", "medium")
            
            print(f"\n[{idx+1}] {exercise_name} ì²˜ë¦¬ ì¤‘...")
            
            # guide_poses ìƒì„±
            try:
                rec["guide_poses"] = await generate_guide_poses(exercise_name)
                
                if not rec["guide_poses"] or len(rec["guide_poses"]) < 2:
                    print(f"âš ï¸ guide_poses ë¶€ì¡±! ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš©")
                    rec["guide_poses"] = get_default_guide_poses_with_animation()
                
                print(f"âœ… guide_poses: {len(rec['guide_poses'])}ê°œ í”„ë ˆì„")
                
            except Exception as e:
                print(f"âŒ guide_poses ìƒì„± ì‹¤íŒ¨: {e}")
                rec["guide_poses"] = get_default_guide_poses_with_animation()
            
            # silhouette_animation ìƒì„±
            try:
                rec["silhouette_animation"] = generate_silhouette_from_guide_poses(
                    guide_poses=rec["guide_poses"],
                    duration_seconds=rec.get("duration_minutes", 10) * 60,
                    intensity=intensity
                )
                print(f"âœ… silhouette_animation: {len(rec['silhouette_animation']['keyframes'])}ê°œ í‚¤í”„ë ˆì„")
                
            except Exception as e:
                print(f"âŒ silhouette_animation ìƒì„± ì‹¤íŒ¨: {e}")
                # ìµœì†Œí•œì˜ ì• ë‹ˆë©”ì´ì…˜
                rec["silhouette_animation"] = {
                    "fps": 30,
                    "keyframes": [
                        {
                            "timestamp_ms": 0,
                            "pose_landmarks": convert_guide_pose_to_landmarks(rec["guide_poses"][0]),
                            "description": "ì‹œì‘"
                        }
                    ]
                }
        
        return recommendations

    except Exception as e:
        print(f"âŒ OpenAI API ì˜¤ë¥˜: {e}")
        return []

# âœ… async ì¶”ê°€ ë° await ì¶”ê°€
async def generate_poses_with_ai(exercise_name: str) -> List[Dict[str, Dict[str, float]]]:
    """
    AIë¥¼ ì‚¬ìš©í•˜ì—¬ ìš´ë™ í¬ì¦ˆ ìƒì„±
    
    Args:
        exercise_name: ìš´ë™ ì´ë¦„ (ì˜ˆ: "ë²½ ëŒ€ê³  íŒ” êµ½íˆê¸°")
    
    Returns:
        MediaPipe 33ê°œ ëœë“œë§ˆí¬ í¬ì¦ˆ ë¦¬ìŠ¤íŠ¸ (2-4ê°œ í”„ë ˆì„)
    """
    prompt = f"""
ë‹¹ì‹ ì€ ìš´ë™ ë™ì‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ìš´ë™ì˜ **MediaPipe Pose ëœë“œë§ˆí¬ ì¢Œí‘œ**ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

**ìš´ë™ ì´ë¦„:** {exercise_name}

**MediaPipe Pose ëœë“œë§ˆí¬ ì •ë³´:**
- 0: ì½” (nose)
- 11: ì™¼ìª½ ì–´ê¹¨ (left shoulder)
- 12: ì˜¤ë¥¸ìª½ ì–´ê¹¨ (right shoulder)
- 13: ì™¼ìª½ íŒ”ê¿ˆì¹˜ (left elbow)
- 14: ì˜¤ë¥¸ìª½ íŒ”ê¿ˆì¹˜ (right elbow)
- 15: ì™¼ìª½ ì†ëª© (left wrist)
- 16: ì˜¤ë¥¸ìª½ ì†ëª© (right wrist)
- 19: ì™¼ìª½ ê²€ì§€ (left index)
- 20: ì˜¤ë¥¸ìª½ ê²€ì§€ (right index)
- 23: ì™¼ìª½ ì—‰ë©ì´ (left hip)
- 24: ì˜¤ë¥¸ìª½ ì—‰ë©ì´ (right hip)
- 25: ì™¼ìª½ ë¬´ë¦ (left knee)
- 26: ì˜¤ë¥¸ìª½ ë¬´ë¦ (right knee)
- 27: ì™¼ìª½ ë°œëª© (left ankle)
- 28: ì˜¤ë¥¸ìª½ ë°œëª© (right ankle)
- 31: ì™¼ìª½ ë°œë (left foot index)
- 32: ì˜¤ë¥¸ìª½ ë°œë (right foot index)

**ì¢Œí‘œ ê·œì¹™:**
- x: 0.0 (ì™¼ìª½) ~ 1.0 (ì˜¤ë¥¸ìª½), ì¤‘ì•™ì€ 0.5
- y: 0.0 (ìœ„) ~ 1.0 (ì•„ë˜), ë¨¸ë¦¬ëŠ” 0.1-0.2, ë°œì€ 0.95-0.98
- ì„œìˆëŠ” ìì„¸: ë¨¸ë¦¬ y=0.15, ì–´ê¹¨ y=0.3, ì—‰ë©ì´ y=0.6, ë¬´ë¦ y=0.8, ë°œëª© y=0.95
- ì•‰ì€ ìì„¸: ë¨¸ë¦¬ y=0.25, ì–´ê¹¨ y=0.35, ì—‰ë©ì´ y=0.65, ë¬´ë¦ y=0.8, ë°œëª© y=0.95

**ìƒì„± ìš”ì²­:**
ì´ ìš´ë™ì˜ í•µì‹¬ ë™ì‘ì„ **2-4ê°œ í”„ë ˆì„**ìœ¼ë¡œ í‘œí˜„í•´ì£¼ì„¸ìš”.
ì˜ˆ: ìŠ¤ì¿¼íŠ¸ëŠ” "ì„œìˆê¸° â†’ ì•‰ê¸°" 2í”„ë ˆì„, íŒ” ëŒë¦¬ê¸°ëŠ” "ìœ„ â†’ ì˜¤ë¥¸ìª½ â†’ ì•„ë˜ â†’ ì™¼ìª½" 4í”„ë ˆì„

**ì‘ë‹µ JSON í˜•ì‹:**
{{
  "frames": [
    {{
      "0": {{"x": 0.5, "y": 0.15}},
      "11": {{"x": 0.4, "y": 0.3}},
      "12": {{"x": 0.6, "y": 0.3}},
      "13": {{"x": 0.35, "y": 0.5}},
      "14": {{"x": 0.65, "y": 0.5}},
      "15": {{"x": 0.3, "y": 0.7}},
      "16": {{"x": 0.7, "y": 0.7}},
      "19": {{"x": 0.28, "y": 0.72}},
      "20": {{"x": 0.72, "y": 0.72}},
      "23": {{"x": 0.42, "y": 0.6}},
      "24": {{"x": 0.58, "y": 0.6}},
      "25": {{"x": 0.4, "y": 0.8}},
      "26": {{"x": 0.6, "y": 0.8}},
      "27": {{"x": 0.38, "y": 0.95}},
      "28": {{"x": 0.62, "y": 0.95}},
      "31": {{"x": 0.36, "y": 0.98}},
      "32": {{"x": 0.64, "y": 0.98}}
    }},
    {{
      "0": {{"x": 0.5, "y": 0.25}},
      "11": {{"x": 0.4, "y": 0.4}},
      ...
    }}
  ]
}}

**ì¤‘ìš”:**
1. ë°˜ë“œì‹œ ìµœì†Œí•œ ëœë“œë§ˆí¬ 0, 11, 12, 13, 14, 15, 16, 19, 20, 23, 24, 25, 26, 27, 28, 31, 32ë¥¼ í¬í•¨í•˜ì„¸ìš”.
2. ì¢Œí‘œëŠ” 0.0-1.0 ë²”ìœ„ ë‚´ì—ì„œë§Œ!
3. ìì—°ìŠ¤ëŸ¬ìš´ ì‚¬ëŒ ë™ì‘ìœ¼ë¡œ!
4. JSONë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´).
"""

    try:
        # âœ… await ì¶”ê°€
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ìš´ë™ ë™ì‘ì„ MediaPipe Pose ì¢Œí‘œë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•­ìƒ ìœ íš¨í•œ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”."},
                {"role": "user", "content": prompt}
            ],
            response_format={"type": "json_object"},
            temperature=0.7,
            max_tokens=2500
        )
        
        content = response.choices[0].message.content
        if content.strip().startswith("```json"):
            content = content.strip()[7:-3]
        
        result = json.loads(content)
        frames = result.get("frames", [])
        
        if frames and len(frames) >= 2:
            print(f"âœ… AI í¬ì¦ˆ ìƒì„± ì„±ê³µ: {len(frames)}ê°œ í”„ë ˆì„")
            return frames
        else:
            print(f"âš ï¸ AI í¬ì¦ˆ ìƒì„± ì‹¤íŒ¨: í”„ë ˆì„ ë¶€ì¡±")
            return None
            
    except Exception as e:
        print(f"âŒ AI í¬ì¦ˆ ìƒì„± ì˜¤ë¥˜: {e}")
        return None

# ... (ë‚˜ë¨¸ì§€ ëª¨ë“  í•¨ìˆ˜ë“¤ì€ ë™ì¼í•˜ê²Œ ìœ ì§€)
# âœ¨ ì†ëª© ìš´ë™ ê°€ì´ë“œ í¬ì¦ˆ ì¶”ê°€
def get_neck_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ëª© ëŒë¦¬ê¸°/ìˆ™ì´ê¸° ê°€ì´ë“œ í¬ì¦ˆ (4ê°œ í”„ë ˆì„ìœ¼ë¡œ íšŒì „ í‘œí˜„)"""
    return [
        # í”„ë ˆì„ 1: ëª© ì¤‘ì•™ (ì‹œì‘)
        {
            "0": {"x": 0.5, "y": 0.15},   # ì½” ì¤‘ì•™
            "1": {"x": 0.51, "y": 0.14},  # ì–¼êµ´ ëœë“œë§ˆí¬
            "2": {"x": 0.52, "y": 0.14},
            "3": {"x": 0.53, "y": 0.14},
            "4": {"x": 0.49, "y": 0.14},
            "5": {"x": 0.48, "y": 0.14},
            "6": {"x": 0.47, "y": 0.14},
            "7": {"x": 0.54, "y": 0.16},  # ê·€
            "8": {"x": 0.46, "y": 0.16},
            "9": {"x": 0.51, "y": 0.18},  # ì…
            "10": {"x": 0.49, "y": 0.18},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ëª© ì™¼ìª½ìœ¼ë¡œ ê¸°ìš¸ì´ê¸°
        {
            "0": {"x": 0.45, "y": 0.15},   # ì½” ì™¼ìª½ìœ¼ë¡œ
            "1": {"x": 0.46, "y": 0.14},
            "2": {"x": 0.47, "y": 0.14},
            "3": {"x": 0.48, "y": 0.14},
            "4": {"x": 0.44, "y": 0.14},
            "5": {"x": 0.43, "y": 0.14},
            "6": {"x": 0.42, "y": 0.14},
            "7": {"x": 0.49, "y": 0.16},
            "8": {"x": 0.41, "y": 0.16},
            "9": {"x": 0.46, "y": 0.18},
            "10": {"x": 0.44, "y": 0.18},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 3: ëª© ì•„ë˜ë¡œ ìˆ™ì´ê¸°
        {
            "0": {"x": 0.5, "y": 0.2},    # ì½” ì•„ë˜ë¡œ
            "1": {"x": 0.51, "y": 0.19},
            "2": {"x": 0.52, "y": 0.19},
            "3": {"x": 0.53, "y": 0.19},
            "4": {"x": 0.49, "y": 0.19},
            "5": {"x": 0.48, "y": 0.19},
            "6": {"x": 0.47, "y": 0.19},
            "7": {"x": 0.54, "y": 0.21},
            "8": {"x": 0.46, "y": 0.21},
            "9": {"x": 0.51, "y": 0.23},
            "10": {"x": 0.49, "y": 0.23},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 4: ëª© ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê¸°ìš¸ì´ê¸°
        {
            "0": {"x": 0.55, "y": 0.15},   # ì½” ì˜¤ë¥¸ìª½ìœ¼ë¡œ
            "1": {"x": 0.56, "y": 0.14},
            "2": {"x": 0.57, "y": 0.14},
            "3": {"x": 0.58, "y": 0.14},
            "4": {"x": 0.54, "y": 0.14},
            "5": {"x": 0.53, "y": 0.14},
            "6": {"x": 0.52, "y": 0.14},
            "7": {"x": 0.59, "y": 0.16},
            "8": {"x": 0.51, "y": 0.16},
            "9": {"x": 0.56, "y": 0.18},
            "10": {"x": 0.54, "y": 0.18},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        }
    ]

# âœ… ì˜ìì— ì•‰ì•„ í•˜ëŠ” ìš´ë™ ê°€ì´ë“œ í¬ì¦ˆ ì¶”ê°€
def get_sitting_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ì˜ìì— ì•‰ì•„ í•˜ëŠ” ìš´ë™ ê°€ì´ë“œ í¬ì¦ˆ (ì•‰ì€ ìì„¸ ê¸°ë³¸)"""
    return [
        # í”„ë ˆì„ 1: ì•‰ì•„ì„œ íŒ” ë‚´ë¦¼
        {
            "0": {"x": 0.5, "y": 0.25},    # ì•‰ì€ ìì„¸ - ë¨¸ë¦¬ ìœ„ì¹˜
            "11": {"x": 0.4, "y": 0.35},   # ì–´ê¹¨
            "12": {"x": 0.6, "y": 0.35},
            "13": {"x": 0.35, "y": 0.5},   # íŒ”ê¿ˆì¹˜
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.65},   # ì†ëª©
            "16": {"x": 0.7, "y": 0.65},
            "19": {"x": 0.28, "y": 0.67},
            "20": {"x": 0.72, "y": 0.67},
            "23": {"x": 0.42, "y": 0.65},  # ì—‰ë©ì´ (ì•‰ì€ ìœ„ì¹˜)
            "24": {"x": 0.58, "y": 0.65},
            "25": {"x": 0.38, "y": 0.8},   # ë¬´ë¦ (90ë„ êµ½í˜)
            "26": {"x": 0.62, "y": 0.8},
            "27": {"x": 0.36, "y": 0.95},  # ë°œëª©
            "28": {"x": 0.64, "y": 0.95},
            "31": {"x": 0.34, "y": 0.98},  # ë°œë
            "32": {"x": 0.66, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ì•‰ì•„ì„œ íŒ” ë“¤ê¸° ë˜ëŠ” ë‹¤ë¦¬ ë»—ê¸°
        {
            "0": {"x": 0.5, "y": 0.25},
            "11": {"x": 0.4, "y": 0.35},
            "12": {"x": 0.6, "y": 0.35},
            "13": {"x": 0.3, "y": 0.4},    # íŒ” ìœ„ë¡œ
            "14": {"x": 0.7, "y": 0.4},
            "15": {"x": 0.25, "y": 0.35},  # ì† ìœ„ë¡œ
            "16": {"x": 0.75, "y": 0.35},
            "19": {"x": 0.23, "y": 0.34},
            "20": {"x": 0.77, "y": 0.34},
            "23": {"x": 0.42, "y": 0.65},
            "24": {"x": 0.58, "y": 0.65},
            "25": {"x": 0.38, "y": 0.75},  # ë‹¤ë¦¬ ì•½ê°„ í´ê¸°
            "26": {"x": 0.62, "y": 0.75},
            "27": {"x": 0.36, "y": 0.9},
            "28": {"x": 0.64, "y": 0.9},
            "31": {"x": 0.34, "y": 0.93},
            "32": {"x": 0.66, "y": 0.93}
        }
    ]

def get_wrist_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ì†ëª© ëŒë¦¬ê¸°/êµ½íˆê¸° ê°€ì´ë“œ í¬ì¦ˆ (4ê°œ í”„ë ˆì„ìœ¼ë¡œ íšŒì „ í‘œí˜„)"""
    return [
        # í”„ë ˆì„ 1: ì†ëª© ì¤‘ì•™ (ì‹œì‘)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.45},
            "14": {"x": 0.65, "y": 0.45},
            "15": {"x": 0.32, "y": 0.6},
            "16": {"x": 0.68, "y": 0.6},
            "19": {"x": 0.3, "y": 0.65},
            "20": {"x": 0.7, "y": 0.65},
            "21": {"x": 0.28, "y": 0.63},
            "22": {"x": 0.72, "y": 0.63},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ì†ëª© ì˜¤ë¥¸ìª½ìœ¼ë¡œ
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.45},
            "14": {"x": 0.65, "y": 0.45},
            "15": {"x": 0.32, "y": 0.6},
            "16": {"x": 0.68, "y": 0.6},
            "19": {"x": 0.35, "y": 0.6},
            "20": {"x": 0.73, "y": 0.6},
            "21": {"x": 0.3, "y": 0.58},
            "22": {"x": 0.7, "y": 0.58},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 3: ì†ëª© ì•„ë˜ë¡œ
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.45},
            "14": {"x": 0.65, "y": 0.45},
            "15": {"x": 0.32, "y": 0.6},
            "16": {"x": 0.68, "y": 0.6},
            "19": {"x": 0.3, "y": 0.55},
            "20": {"x": 0.7, "y": 0.55},
            "21": {"x": 0.28, "y": 0.57},
            "22": {"x": 0.72, "y": 0.57},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 4: ì†ëª© ì™¼ìª½ìœ¼ë¡œ
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.45},
            "14": {"x": 0.65, "y": 0.45},
            "15": {"x": 0.32, "y": 0.6},
            "16": {"x": 0.68, "y": 0.6},
            "19": {"x": 0.27, "y": 0.6},
            "20": {"x": 0.65, "y": 0.6},
            "21": {"x": 0.3, "y": 0.62},
            "22": {"x": 0.68, "y": 0.62},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        }
    ]
    
# âœ¨ ì–´ê¹¨ ìš´ë™ ê°€ì´ë“œ í¬ì¦ˆ ì¶”ê°€
def get_shoulder_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ì–´ê¹¨ ëŒë¦¬ê¸°/ìœ¼ì“±í•˜ê¸° ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        # í”„ë ˆì„ 1: ì–´ê¹¨ ë‚´ë¦¼
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.35},
            "12": {"x": 0.6, "y": 0.35},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ì–´ê¹¨ ì˜¬ë¦¼ (ìœ¼ì“±)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.25},
            "12": {"x": 0.6, "y": 0.25},
            "13": {"x": 0.35, "y": 0.4},
            "14": {"x": 0.65, "y": 0.4},
            "15": {"x": 0.3, "y": 0.6},
            "16": {"x": 0.7, "y": 0.6},
            "19": {"x": 0.28, "y": 0.62},
            "20": {"x": 0.72, "y": 0.62},
            "23": {"x": 0.42, "y": 0.55},
            "24": {"x": 0.58, "y": 0.55},
            "25": {"x": 0.4, "y": 0.75},
            "26": {"x": 0.6, "y": 0.75},
            "27": {"x": 0.38, "y": 0.9},
            "28": {"x": 0.62, "y": 0.9},
            "31": {"x": 0.36, "y": 0.93},
            "32": {"x": 0.64, "y": 0.93}
        }
    ]

# âœ¨ íŒ” ë“¤ê¸° ìš´ë™ ê°€ì´ë“œ í¬ì¦ˆ ì¶”ê°€
def get_arm_raise_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """íŒ” ë²Œë¦¬ê¸°/ë“¤ê¸° ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        # í”„ë ˆì„ 1: íŒ” ë‚´ë¦¼
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: íŒ” ì˜†ìœ¼ë¡œ ë²Œë¦¼ (90ë„)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.25, "y": 0.35},
            "14": {"x": 0.75, "y": 0.35},
            "15": {"x": 0.15, "y": 0.35},
            "16": {"x": 0.85, "y": 0.35},
            "19": {"x": 0.12, "y": 0.35},
            "20": {"x": 0.88, "y": 0.35},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        }
    ]
    
def get_ankle_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ë°œëª© ëŒë¦¬ê¸°/êµ½íˆê¸° ê°€ì´ë“œ í¬ì¦ˆ (4ê°œ í”„ë ˆì„ìœ¼ë¡œ íšŒì „ í‘œí˜„)"""
    return [
        # í”„ë ˆì„ 1: ë°œëª© ì¤‘ì•™ (ì‹œì‘)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.92},
            "28": {"x": 0.62, "y": 0.92},
            "29": {"x": 0.36, "y": 0.93},
            "30": {"x": 0.64, "y": 0.93},
            "31": {"x": 0.38, "y": 0.95},
            "32": {"x": 0.62, "y": 0.95}
        },
        # í”„ë ˆì„ 2: ë°œë ìœ„ë¡œ (ë°œëª© êµ½í˜)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.92},
            "28": {"x": 0.62, "y": 0.92},
            "29": {"x": 0.36, "y": 0.95},
            "30": {"x": 0.64, "y": 0.95},
            "31": {"x": 0.38, "y": 0.88},
            "32": {"x": 0.62, "y": 0.88}
        },
        # í”„ë ˆì„ 3: ë°œë ì˜¤ë¥¸ìª½ìœ¼ë¡œ
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.92},
            "28": {"x": 0.62, "y": 0.92},
            "29": {"x": 0.34, "y": 0.93},
            "30": {"x": 0.6, "y": 0.93},
            "31": {"x": 0.32, "y": 0.95},
            "32": {"x": 0.66, "y": 0.95}
        },
        # í”„ë ˆì„ 4: ë°œë ì•„ë˜ë¡œ (ë°œëª© í´ê¸°)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.92},
            "28": {"x": 0.62, "y": 0.92},
            "29": {"x": 0.36, "y": 0.9},
            "30": {"x": 0.64, "y": 0.9},
            "31": {"x": 0.38, "y": 0.98},
            "32": {"x": 0.62, "y": 0.98}
        }
    ]


# âœ¨ ì¢…ì•„ë¦¬(ì¹´í”„) ë ˆì´ì¦ˆ ê°€ì´ë“œ í¬ì¦ˆ ì¶”ê°€
def get_calf_raise_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ì¢…ì•„ë¦¬ ì˜¬ë¦¬ê¸° (ì¹´í”„ ë ˆì´ì¦ˆ) ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        # í”„ë ˆì„ 1: ë°œë’¤ê¿ˆì¹˜ ë‚´ë¦¼ (ì‹œì‘)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "29": {"x": 0.36, "y": 0.97},
            "30": {"x": 0.64, "y": 0.97},
            "31": {"x": 0.38, "y": 0.98},
            "32": {"x": 0.62, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ë°œë’¤ê¿ˆì¹˜ ì˜¬ë¦¼ (ê¹Œì¹˜ë°œ)
        {
            "0": {"x": 0.5, "y": 0.1},
            "11": {"x": 0.4, "y": 0.25},
            "12": {"x": 0.6, "y": 0.25},
            "13": {"x": 0.35, "y": 0.45},
            "14": {"x": 0.65, "y": 0.45},
            "15": {"x": 0.3, "y": 0.65},
            "16": {"x": 0.7, "y": 0.65},
            "19": {"x": 0.28, "y": 0.67},
            "20": {"x": 0.72, "y": 0.67},
            "23": {"x": 0.42, "y": 0.55},
            "24": {"x": 0.58, "y": 0.55},
            "25": {"x": 0.4, "y": 0.75},
            "26": {"x": 0.6, "y": 0.75},
            "27": {"x": 0.38, "y": 0.88},
            "28": {"x": 0.62, "y": 0.88},
            "29": {"x": 0.36, "y": 0.85},
            "30": {"x": 0.64, "y": 0.85},
            "31": {"x": 0.38, "y": 0.98},
            "32": {"x": 0.62, "y": 0.98}
        }
    ]


def get_squat_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ìŠ¤ì¿¼íŠ¸ ê°€ì´ë“œ í¬ì¦ˆ (ì†ëª©, ë°œëª©ê¹Œì§€ ì„¸ë°€í•˜ê²Œ)"""
    return [
        # í”„ë ˆì„ 1: ì„œìˆëŠ” ìì„¸
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ì•‰ì€ ìì„¸
        {
            "0": {"x": 0.5, "y": 0.25},
            "11": {"x": 0.4, "y": 0.4},
            "12": {"x": 0.6, "y": 0.4},
            "13": {"x": 0.32, "y": 0.55},
            "14": {"x": 0.68, "y": 0.55},
            "15": {"x": 0.25, "y": 0.7},
            "16": {"x": 0.75, "y": 0.7},
            "19": {"x": 0.23, "y": 0.72},
            "20": {"x": 0.77, "y": 0.72},
            "23": {"x": 0.42, "y": 0.75},
            "24": {"x": 0.58, "y": 0.75},
            "25": {"x": 0.35, "y": 0.85},
            "26": {"x": 0.65, "y": 0.85},
            "27": {"x": 0.33, "y": 0.95},
            "28": {"x": 0.67, "y": 0.95},
            "31": {"x": 0.31, "y": 0.98},
            "32": {"x": 0.69, "y": 0.98}
        }
    ]


def get_lunge_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ëŸ°ì§€ ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        {
            "0": {"x": 0.5, "y": 0.2},
            "11": {"x": 0.4, "y": 0.35},
            "12": {"x": 0.6, "y": 0.35},
            "13": {"x": 0.32, "y": 0.55},
            "14": {"x": 0.68, "y": 0.55},
            "15": {"x": 0.28, "y": 0.75},
            "16": {"x": 0.72, "y": 0.75},
            "23": {"x": 0.42, "y": 0.65},
            "24": {"x": 0.58, "y": 0.65},
            "25": {"x": 0.35, "y": 0.8},
            "26": {"x": 0.65, "y": 0.85},
            "27": {"x": 0.33, "y": 0.92},
            "28": {"x": 0.67, "y": 0.97},
            "29": {"x": 0.32, "y": 0.93},
            "30": {"x": 0.68, "y": 0.98},
            "31": {"x": 0.31, "y": 0.95},
            "32": {"x": 0.69, "y": 0.99}
        }
    ]


def get_plank_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """í”Œë­í¬ ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        {
            "0": {"x": 0.5, "y": 0.4},
            "11": {"x": 0.35, "y": 0.45},
            "12": {"x": 0.65, "y": 0.45},
            "13": {"x": 0.25, "y": 0.5},
            "14": {"x": 0.75, "y": 0.5},
            "15": {"x": 0.2, "y": 0.55},
            "16": {"x": 0.8, "y": 0.55},
            "19": {"x": 0.18, "y": 0.56},
            "20": {"x": 0.82, "y": 0.56},
            "23": {"x": 0.38, "y": 0.55},
            "24": {"x": 0.62, "y": 0.55},
            "25": {"x": 0.4, "y": 0.65},
            "26": {"x": 0.6, "y": 0.65},
            "27": {"x": 0.42, "y": 0.75},
            "28": {"x": 0.58, "y": 0.75},
            "31": {"x": 0.44, "y": 0.78},
            "32": {"x": 0.56, "y": 0.78}
        }
    ]


def get_pushup_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """íŒ”êµ½í˜€í´ê¸° ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        {
            "0": {"x": 0.5, "y": 0.35},
            "11": {"x": 0.35, "y": 0.4},
            "12": {"x": 0.65, "y": 0.4},
            "13": {"x": 0.25, "y": 0.45},
            "14": {"x": 0.75, "y": 0.45},
            "15": {"x": 0.2, "y": 0.5},
            "16": {"x": 0.8, "y": 0.5},
            "19": {"x": 0.18, "y": 0.52},
            "20": {"x": 0.82, "y": 0.52},
            "23": {"x": 0.38, "y": 0.5},
            "24": {"x": 0.62, "y": 0.5},
            "25": {"x": 0.4, "y": 0.6},
            "26": {"x": 0.6, "y": 0.6},
            "27": {"x": 0.42, "y": 0.7},
            "28": {"x": 0.58, "y": 0.7},
            "31": {"x": 0.44, "y": 0.73},
            "32": {"x": 0.56, "y": 0.73}
        },
        {
            "0": {"x": 0.5, "y": 0.47},
            "11": {"x": 0.35, "y": 0.52},
            "12": {"x": 0.65, "y": 0.52},
            "13": {"x": 0.28, "y": 0.54},
            "14": {"x": 0.72, "y": 0.54},
            "15": {"x": 0.2, "y": 0.55},
            "16": {"x": 0.8, "y": 0.55},
            "19": {"x": 0.18, "y": 0.56},
            "20": {"x": 0.82, "y": 0.56},
            "23": {"x": 0.38, "y": 0.58},
            "24": {"x": 0.62, "y": 0.58},
            "25": {"x": 0.4, "y": 0.68},
            "26": {"x": 0.6, "y": 0.68},
            "27": {"x": 0.42, "y": 0.78},
            "28": {"x": 0.58, "y": 0.78},
            "31": {"x": 0.44, "y": 0.81},
            "32": {"x": 0.56, "y": 0.81}
        }
    ]


def get_leg_raise_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """
    ë ˆê·¸ ë ˆì´ì¦ˆ (í•˜ì²´ ì˜¬ë¦¬ê¸°) ê°€ì´ë“œ í¬ì¦ˆ
    âœ… ìˆ˜ì •: ë” ëª…í™•í•œ ë‹¤ë¦¬ ì˜¬ë¦¬ê¸° ë™ì‘
    """
    return [
        # í”„ë ˆì„ 1: ë‹¤ë¦¬ ë‚´ë¦¼ (ì‹œì‘)
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.45, "y": 0.3},
            "12": {"x": 0.55, "y": 0.3},
            "13": {"x": 0.4, "y": 0.5},
            "14": {"x": 0.6, "y": 0.5},
            "15": {"x": 0.35, "y": 0.7},
            "16": {"x": 0.65, "y": 0.7},
            "19": {"x": 0.33, "y": 0.72},
            "20": {"x": 0.67, "y": 0.72},
            "23": {"x": 0.48, "y": 0.6},
            "24": {"x": 0.52, "y": 0.6},
            "25": {"x": 0.48, "y": 0.8},
            "26": {"x": 0.52, "y": 0.8},
            "27": {"x": 0.48, "y": 0.95},
            "28": {"x": 0.52, "y": 0.95},
            "31": {"x": 0.48, "y": 0.98},
            "32": {"x": 0.52, "y": 0.98}
        },
        # í”„ë ˆì„ 2: ì™¼ìª½ ë‹¤ë¦¬ ì˜¬ë¦¬ê¸°
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.45, "y": 0.3},
            "12": {"x": 0.55, "y": 0.3},
            "13": {"x": 0.4, "y": 0.5},
            "14": {"x": 0.6, "y": 0.5},
            "15": {"x": 0.35, "y": 0.7},
            "16": {"x": 0.65, "y": 0.7},
            "19": {"x": 0.33, "y": 0.72},
            "20": {"x": 0.67, "y": 0.72},
            "23": {"x": 0.48, "y": 0.6},
            "24": {"x": 0.52, "y": 0.6},
            "25": {"x": 0.35, "y": 0.65},  # ì™¼ìª½ ë¬´ë¦ ì˜¬ë¼ê°
            "26": {"x": 0.52, "y": 0.8},   # ì˜¤ë¥¸ìª½ ë‹¤ë¦¬ëŠ” ê·¸ëŒ€ë¡œ
            "27": {"x": 0.25, "y": 0.7},   # ì™¼ìª½ ë°œëª© ì˜¬ë¼ê°
            "28": {"x": 0.52, "y": 0.95},
            "31": {"x": 0.22, "y": 0.73},  # ì™¼ìª½ ë°œë ì˜¬ë¼ê°
            "32": {"x": 0.52, "y": 0.98}
        },
        # í”„ë ˆì„ 3: ë‹¤ì‹œ ë‚´ë¦¼
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.45, "y": 0.3},
            "12": {"x": 0.55, "y": 0.3},
            "13": {"x": 0.4, "y": 0.5},
            "14": {"x": 0.6, "y": 0.5},
            "15": {"x": 0.35, "y": 0.7},
            "16": {"x": 0.65, "y": 0.7},
            "19": {"x": 0.33, "y": 0.72},
            "20": {"x": 0.67, "y": 0.72},
            "23": {"x": 0.48, "y": 0.6},
            "24": {"x": 0.52, "y": 0.6},
            "25": {"x": 0.48, "y": 0.8},
            "26": {"x": 0.52, "y": 0.8},
            "27": {"x": 0.48, "y": 0.95},
            "28": {"x": 0.52, "y": 0.95},
            "31": {"x": 0.48, "y": 0.98},
            "32": {"x": 0.52, "y": 0.98}
        }
    ]

def get_stretching_guide_poses() -> List[Dict[str, Dict[str, float]]]:
    """ìŠ¤íŠ¸ë ˆì¹­ ê°€ì´ë“œ í¬ì¦ˆ"""
    return [
        {
            "0": {"x": 0.5, "y": 0.2},
            "11": {"x": 0.4, "y": 0.35},
            "12": {"x": 0.6, "y": 0.35},
            "13": {"x": 0.3, "y": 0.4},
            "14": {"x": 0.7, "y": 0.4},
            "15": {"x": 0.2, "y": 0.45},
            "16": {"x": 0.8, "y": 0.45},
            "19": {"x": 0.18, "y": 0.46},
            "20": {"x": 0.82, "y": 0.46},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        }
    ]


def get_default_guide_poses_with_animation() -> List[Dict[str, Dict[str, float]]]:
    """
    ê¸°ë³¸ ê°€ì´ë“œ í¬ì¦ˆ (ì„œìˆëŠ” ìì„¸ â†’ íŒ” ì˜¬ë¦¬ê¸° â†’ ì„œìˆëŠ” ìì„¸)
    âœ… ë°˜ë“œì‹œ 3ê°œ ì´ìƒì˜ í”„ë ˆì„ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜ ê°€ëŠ¥í•˜ê²Œ!
    """
    return [
        # í”„ë ˆì„ 1: ì„œìˆëŠ” ìì„¸
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 2: íŒ” ì˜†ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.25, "y": 0.35},
            "14": {"x": 0.75, "y": 0.35},
            "15": {"x": 0.15, "y": 0.35},
            "16": {"x": 0.85, "y": 0.35},
            "19": {"x": 0.12, "y": 0.35},
            "20": {"x": 0.88, "y": 0.35},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        },
        # í”„ë ˆì„ 3: ë‹¤ì‹œ íŒ” ë‚´ë¦¬ê¸°
        {
            "0": {"x": 0.5, "y": 0.15},
            "11": {"x": 0.4, "y": 0.3},
            "12": {"x": 0.6, "y": 0.3},
            "13": {"x": 0.35, "y": 0.5},
            "14": {"x": 0.65, "y": 0.5},
            "15": {"x": 0.3, "y": 0.7},
            "16": {"x": 0.7, "y": 0.7},
            "19": {"x": 0.28, "y": 0.72},
            "20": {"x": 0.72, "y": 0.72},
            "23": {"x": 0.42, "y": 0.6},
            "24": {"x": 0.58, "y": 0.6},
            "25": {"x": 0.4, "y": 0.8},
            "26": {"x": 0.6, "y": 0.8},
            "27": {"x": 0.38, "y": 0.95},
            "28": {"x": 0.62, "y": 0.95},
            "31": {"x": 0.36, "y": 0.98},
            "32": {"x": 0.64, "y": 0.98}
        }
    ]

# --- ì•„ë˜ëŠ” ê¸°ì¡´ í—¬í¼ í•¨ìˆ˜ë“¤ ---

async def get_base_template(db, exercise_type: str, user_body_condition: Dict) -> Dict:
    injured_parts = user_body_condition.get("injured_parts", [])
    query = {"category": exercise_type, "contraindications": {"$not": {"$in": injured_parts}} if injured_parts else {}}
    return await db.exercise_templates.find_one(query)

async def create_default_template(exercise_name: str = None) -> Dict:
    """
    ìš´ë™ ì´ë¦„ì— ë”°ë¼ ì ì ˆí•œ ê¸°ë³¸ í…œí”Œë¦¿ ë°˜í™˜
    """
    
    # ìš´ë™ ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„œìˆëŠ” ìì„¸
    if not exercise_name:
        return {
            "_id": None,
            "name": "ê¸°ë³¸ ìš´ë™",
            "category": "rehabilitation",
            "target_parts": ["ì „ì‹ "],
            "contraindications": [],
            "base_animation": {
                "fps": 30,
                "keyframes": [
                    {
                        "frame_number": 0,
                        "timestamp_ms": 0,
                        "pose_landmarks": generate_standing_pose(),
                        "description": "ì‹œì‘ ìì„¸"
                    }
                ]
            },
            "reference_angles": {}
        }
    
    exercise_name_lower = exercise_name.lower()
    
    # ìŠ¤ì¿¼íŠ¸ ê³„ì—´
    if "ìŠ¤ì¿¼íŠ¸" in exercise_name_lower or "squat" in exercise_name_lower:
        return {
            "_id": None,
            "name": "ê¸°ë³¸ ìŠ¤ì¿¼íŠ¸",
            "category": "rehabilitation",
            "target_parts": ["ë¬´ë¦", "í—ˆë²…ì§€", "ì—‰ë©ì´"],
            "contraindications": [],
            "base_animation": {
                "fps": 30,
                "keyframes": [
                    {
                        "frame_number": 0,
                        "timestamp_ms": 0,
                        "pose_landmarks": generate_standing_pose(),
                        "description": "ì‹œì‘ ìì„¸"
                    },
                    {
                        "frame_number": 60,
                        "timestamp_ms": 2000,
                        "pose_landmarks": generate_squat_pose(),
                        "description": "ë¬´ë¦ 90ë„ êµ½í˜"
                    },
                    {
                        "frame_number": 120,
                        "timestamp_ms": 4000,
                        "pose_landmarks": generate_standing_pose(),
                        "description": "ì›ìœ„ì¹˜"
                    }
                ]
            },
            "reference_angles": {
                "left_knee_min": 160,
                "left_knee_max": 90,
                "right_knee_min": 160,
                "right_knee_max": 90
            }
        }
    
    # ì˜ì ìš´ë™
    elif "ì˜ì" in exercise_name_lower or "ì•‰ì•„" in exercise_name_lower:
        return {
            "_id": None,
            "name": "ì˜ì ìš´ë™",
            "category": "rehabilitation",
            "target_parts": ["ë‹¤ë¦¬", "ì½”ì–´"],
            "contraindications": [],
            "base_animation": {
                "fps": 30,
                "keyframes": [
                    {
                        "frame_number": 0,
                        "timestamp_ms": 0,
                        "pose_landmarks": generate_sitting_pose(),
                        "description": "ì•‰ì€ ìì„¸"
                    }
                ]
            },
            "reference_angles": {}
        }
    
    # íŒ” ìš´ë™
    elif "íŒ”" in exercise_name_lower and ("ë“¤ê¸°" in exercise_name_lower or "ë²Œë¦¬ê¸°" in exercise_name_lower):
        return {
            "_id": None,
            "name": "íŒ” ìš´ë™",
            "category": "rehabilitation",
            "target_parts": ["ì–´ê¹¨", "íŒ”"],
            "contraindications": [],
            "base_animation": {
                "fps": 30,
                "keyframes": [
                    {
                        "frame_number": 0,
                        "timestamp_ms": 0,
                        "pose_landmarks": generate_standing_pose(),
                        "description": "íŒ” ë‚´ë¦° ìì„¸"
                    },
                    {
                        "frame_number": 60,
                        "timestamp_ms": 2000,
                        "pose_landmarks": generate_arm_raised_pose(),
                        "description": "íŒ” ë“¤ì–´ì˜¬ë¦¼"
                    }
                ]
            },
            "reference_angles": {}
        }
    
    # ê¸°ë³¸ê°’: ì„œìˆëŠ” ìì„¸
    else:
        return {
            "_id": None,
            "name": exercise_name or "ê¸°ë³¸ ìš´ë™",
            "category": "rehabilitation",
            "target_parts": ["ì „ì‹ "],
            "contraindications": [],
            "base_animation": {
                "fps": 30,
                "keyframes": [
                    {
                        "frame_number": 0,
                        "timestamp_ms": 0,
                        "pose_landmarks": generate_standing_pose(),
                        "description": "ê¸°ë³¸ ìì„¸"
                    }
                ]
            },
            "reference_angles": {}
        }


# ì¶”ê°€ë¡œ í•„ìš”í•œ í¬ì¦ˆ ìƒì„± í•¨ìˆ˜ë“¤

def generate_sitting_pose() -> List[Dict]:
    """ì•‰ì€ ìì„¸ ìƒì„±"""
    sitting_landmarks = []
    for i in range(33):
        if i == 0:  # nose
            sitting_landmarks.append({"x": 0.5, "y": 0.25, "z": -0.1, "visibility": 0.99})
        elif i in [11, 12]:  # shoulders
            x = 0.4 if i == 11 else 0.6
            sitting_landmarks.append({"x": x, "y": 0.35, "z": -0.1, "visibility": 0.99})
        elif i in [13, 14]:  # elbows
            x = 0.35 if i == 13 else 0.65
            sitting_landmarks.append({"x": x, "y": 0.5, "z": -0.1, "visibility": 0.99})
        elif i in [15, 16]:  # wrists
            x = 0.3 if i == 15 else 0.7
            sitting_landmarks.append({"x": x, "y": 0.65, "z": -0.1, "visibility": 0.99})
        elif i in [23, 24]:  # hips (seated)
            x = 0.42 if i == 23 else 0.58
            sitting_landmarks.append({"x": x, "y": 0.65, "z": -0.1, "visibility": 0.99})
        elif i in [25, 26]:  # knees (90 degree bend)
            x = 0.38 if i == 25 else 0.62
            sitting_landmarks.append({"x": x, "y": 0.8, "z": -0.1, "visibility": 0.99})
        elif i in [27, 28]:  # ankles
            x = 0.36 if i == 27 else 0.64
            sitting_landmarks.append({"x": x, "y": 0.95, "z": -0.1, "visibility": 0.99})
        elif i in [31, 32]:  # feet
            x = 0.34 if i == 31 else 0.66
            sitting_landmarks.append({"x": x, "y": 0.98, "z": -0.1, "visibility": 0.99})
        else:
            # ê¸°íƒ€ ëœë“œë§ˆí¬ëŠ” ëŒ€ëµì ì¸ ìœ„ì¹˜
            sitting_landmarks.append({"x": 0.5, "y": 0.5, "z": -0.1, "visibility": 0.5})
    
    return sitting_landmarks


def generate_arm_raised_pose() -> List[Dict]:
    """íŒ” ë“¤ì–´ì˜¬ë¦° ìì„¸ ìƒì„±"""
    arm_raised_landmarks = []
    for i in range(33):
        if i == 0:  # nose
            arm_raised_landmarks.append({"x": 0.5, "y": 0.15, "z": -0.1, "visibility": 0.99})
        elif i in [11, 12]:  # shoulders
            x = 0.4 if i == 11 else 0.6
            arm_raised_landmarks.append({"x": x, "y": 0.3, "z": -0.1, "visibility": 0.99})
        elif i in [13, 14]:  # elbows (raised)
            x = 0.25 if i == 13 else 0.75
            arm_raised_landmarks.append({"x": x, "y": 0.35, "z": -0.1, "visibility": 0.99})
        elif i in [15, 16]:  # wrists (raised high)
            x = 0.15 if i == 15 else 0.85
            arm_raised_landmarks.append({"x": x, "y": 0.35, "z": -0.1, "visibility": 0.99})
        elif i in [23, 24]:  # hips
            x = 0.42 if i == 23 else 0.58
            arm_raised_landmarks.append({"x": x, "y": 0.6, "z": -0.1, "visibility": 0.99})
        elif i in [25, 26]:  # knees
            x = 0.4 if i == 25 else 0.6
            arm_raised_landmarks.append({"x": x, "y": 0.8, "z": -0.1, "visibility": 0.99})
        elif i in [27, 28]:  # ankles
            x = 0.38 if i == 27 else 0.62
            arm_raised_landmarks.append({"x": x, "y": 0.95, "z": -0.1, "visibility": 0.99})
        elif i in [31, 32]:  # feet
            x = 0.36 if i == 31 else 0.64
            arm_raised_landmarks.append({"x": x, "y": 0.98, "z": -0.1, "visibility": 0.99})
        else:
            # ê¸°íƒ€ ëœë“œë§ˆí¬
            arm_raised_landmarks.append({"x": 0.5, "y": 0.5, "z": -0.1, "visibility": 0.5})
    
    return arm_raised_landmarks




def create_exercise_prompt(user_body_condition: Dict, base_template: Dict, exercise_type: str, intensity: str, duration_minutes: int) -> str:
    injured_parts = user_body_condition.get("injured_parts", [])
    pain_level = user_body_condition.get("pain_level", 0)
    limitations = user_body_condition.get("limitations", [])
    return f"""
ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤ ì¬í™œ ìš´ë™ì„ JSON í˜•ì‹ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”:
**ì‚¬ìš©ì ì •ë³´:** - ë¶€ìƒ ë¶€ìœ„: {', '.join(injured_parts) if injured_parts else 'ì—†ìŒ'} - í†µì¦ ìˆ˜ì¤€: {pain_level}/10 - ì œí•œ ì‚¬í•­: {', '.join(limitations) if limitations else 'ì—†ìŒ'}
**ìš´ë™ ìš”êµ¬ì‚¬í•­:** - ìš´ë™ íƒ€ì…: {exercise_type} - ê°•ë„: {intensity} - ëª©í‘œ ì‹œê°„: {duration_minutes}ë¶„ - ê¸°ë³¸ í…œí”Œë¦¿: {base_template.get('name', 'ê¸°ë³¸ ìš´ë™')}
**ìƒì„±í•  JSON í˜•ì‹:**
{{
  "name": "ìš´ë™ ì´ë¦„ (ì˜ˆ: ë¬´ë¦ ë³´í˜¸ ìŠ¤ì¿¼íŠ¸)", "description": "ìš´ë™ ì„¤ëª… (1-2ë¬¸ì¥)",
  "instructions": ["1ë‹¨ê³„: êµ¬ì²´ì ì¸ ë™ì‘ ì„¤ëª…", "2ë‹¨ê³„: êµ¬ì²´ì ì¸ ë™ì‘ ì„¤ëª…", "3ë‹¨ê³„: êµ¬ì²´ì ì¸ ë™ì‘ ì„¤ëª…"],
  "repetitions": 10, "sets": 3, "target_parts": ["íƒ€ê²Ÿ ë¶€ìœ„1", "íƒ€ê²Ÿ ë¶€ìœ„2"],
  "safety_warnings": ["ì£¼ì˜ì‚¬í•­1", "ì£¼ì˜ì‚¬í•­2"]
}}
**ì¤‘ìš” ì§€ì¹¨:**
1. ì‚¬ìš©ìì˜ ë¶€ìƒ ë¶€ìœ„ë¥¼ í”¼í•˜ê±°ë‚˜ ë³´í˜¸í•˜ëŠ” ë™ì‘ìœ¼ë¡œ êµ¬ì„±
2. í†µì¦ ìˆ˜ì¤€ì´ ë†’ìœ¼ë©´ ê°•ë„ë¥¼ ë‚®ì¶”ê³  ê°€ë™ ë²”ìœ„ë¥¼ ì¤„ì„
3. ì•ˆì „ ê²½ê³ ëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì‘ì„±
4. ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±
5. repetitionsì™€ setsëŠ” ê°•ë„ì— ë§ê²Œ ì¡°ì • (low: 8-10íšŒ, medium: 10-12íšŒ, high: 12-15íšŒ)
"""

def create_fallback_exercise(base_template: Dict, intensity: str, duration_minutes: int) -> Dict:
    reps_map = {"low": 8, "medium": 10, "high": 12}
    return {
        "name": f"{base_template.get('name', 'ê¸°ë³¸ ìš´ë™')} (ë§ì¶¤)", "description": "ì‹ ì²´ ìƒíƒœì— ë§ì¶˜ ì•ˆì „í•œ ìš´ë™ì…ë‹ˆë‹¤.",
        "instructions": ["ë°”ë¥¸ ìì„¸ë¡œ ì„œì„œ ì‹œì‘í•˜ì„¸ìš”", "ì²œì²œíˆ ë™ì‘ì„ ìˆ˜í–‰í•˜ì„¸ìš”", "í˜¸í¡ì„ ê·œì¹™ì ìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”", "í†µì¦ì´ ëŠê»´ì§€ë©´ ì¦‰ì‹œ ë©ˆì¶”ì„¸ìš”"],
        "repetitions": reps_map.get(intensity, 10), "sets": 3, "target_parts": base_template.get("target_parts", ["ì „ì‹ "]),
        "safety_warnings": ["í†µì¦ì´ ëŠê»´ì§€ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”", "ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”"]
    }

def customize_animation(base_animation: Dict, intensity: str, user_limitations: List[str]) -> Dict:
    if not base_animation or "keyframes" not in base_animation:
        return {"keyframes": [{"timestamp_ms": 0, "pose_landmarks": generate_standing_pose(), "description": "ì‹œì‘"}]}
    speed_multiplier = get_speed_multiplier(intensity)
    customized_keyframes = []
    for keyframe in base_animation.get("keyframes", []):
        customized_keyframe = {"timestamp_ms": int(keyframe.get("timestamp_ms", 0) / speed_multiplier),
                               "pose_landmarks": adjust_pose_rom(keyframe.get("pose_landmarks", []), user_limitations),
                               "description": keyframe.get("description", "")}
        customized_keyframes.append(customized_keyframe)
    return {"keyframes": customized_keyframes}

def get_speed_multiplier(intensity: str) -> float:
    return {"low": 1.5, "medium": 1.0, "high": 0.7}.get(intensity, 1.0)

def get_rom_adjustment(user_body_condition: Dict) -> Dict:
    pain_level = user_body_condition.get("pain_level", 0)
    if pain_level >= 7: return {"reduction_percent": 40}
    elif pain_level >= 4: return {"reduction_percent": 20}
    else: return {"reduction_percent": 0}

def get_hold_time(intensity: str) -> int:
    return {"low": 2000, "medium": 1000, "high": 500}.get(intensity, 1000)

def adjust_pose_rom(pose_landmarks: List[Dict], user_limitations: List[str]) -> List[Dict]:
    return pose_landmarks

def generate_standing_pose() -> List[Dict]:
    """ì œëŒ€ë¡œ ëœ ì„œìˆëŠ” ìì„¸ ìƒì„± (33ê°œ MediaPipe ëœë“œë§ˆí¬)"""
    # ì‹¤ì œ ì‚¬ëŒì´ ì„œìˆëŠ” ìì„¸ì˜ ëœë“œë§ˆí¬ ì¢Œí‘œ
    standing_landmarks = [
        # ì–¼êµ´ ëœë“œë§ˆí¬ (0-10)
        {"x": 0.5, "y": 0.15, "z": -0.1, "visibility": 0.99},  # 0: nose
        {"x": 0.51, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 1: left eye inner
        {"x": 0.52, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 2: left eye
        {"x": 0.53, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 3: left eye outer
        {"x": 0.49, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 4: right eye inner
        {"x": 0.48, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 5: right eye
        {"x": 0.47, "y": 0.14, "z": -0.1, "visibility": 0.99},  # 6: right eye outer
        {"x": 0.54, "y": 0.16, "z": -0.1, "visibility": 0.99},  # 7: left ear
        {"x": 0.46, "y": 0.16, "z": -0.1, "visibility": 0.99},  # 8: right ear
        {"x": 0.51, "y": 0.18, "z": -0.1, "visibility": 0.99},  # 9: mouth left
        {"x": 0.49, "y": 0.18, "z": -0.1, "visibility": 0.99},  # 10: mouth right
        
        # ëª¸í†µ ëœë“œë§ˆí¬ (11-24)
        {"x": 0.4, "y": 0.3, "z": -0.1, "visibility": 0.99},   # 11: left shoulder
        {"x": 0.6, "y": 0.3, "z": -0.1, "visibility": 0.99},   # 12: right shoulder
        {"x": 0.35, "y": 0.5, "z": -0.1, "visibility": 0.99},  # 13: left elbow
        {"x": 0.65, "y": 0.5, "z": -0.1, "visibility": 0.99},  # 14: right elbow
        {"x": 0.3, "y": 0.7, "z": -0.1, "visibility": 0.99},   # 15: left wrist
        {"x": 0.7, "y": 0.7, "z": -0.1, "visibility": 0.99},   # 16: right wrist
        {"x": 0.28, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 17: left pinky
        {"x": 0.72, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 18: right pinky
        {"x": 0.28, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 19: left index
        {"x": 0.72, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 20: right index
        {"x": 0.28, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 21: left thumb
        {"x": 0.72, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 22: right thumb
        {"x": 0.42, "y": 0.6, "z": -0.1, "visibility": 0.99},  # 23: left hip
        {"x": 0.58, "y": 0.6, "z": -0.1, "visibility": 0.99},  # 24: right hip
        
        # ë‹¤ë¦¬ ëœë“œë§ˆí¬ (25-32)
        {"x": 0.4, "y": 0.8, "z": -0.1, "visibility": 0.99},   # 25: left knee
        {"x": 0.6, "y": 0.8, "z": -0.1, "visibility": 0.99},   # 26: right knee
        {"x": 0.38, "y": 0.95, "z": -0.1, "visibility": 0.99}, # 27: left ankle
        {"x": 0.62, "y": 0.95, "z": -0.1, "visibility": 0.99}, # 28: right ankle
        {"x": 0.36, "y": 0.97, "z": -0.1, "visibility": 0.99}, # 29: left heel
        {"x": 0.64, "y": 0.97, "z": -0.1, "visibility": 0.99}, # 30: right heel
        {"x": 0.36, "y": 0.98, "z": -0.1, "visibility": 0.99}, # 31: left foot index
        {"x": 0.64, "y": 0.98, "z": -0.1, "visibility": 0.99}  # 32: right foot index
    ]
    return standing_landmarks

def generate_squat_pose() -> List[Dict]:
    """ì œëŒ€ë¡œ ëœ ìŠ¤ì¿¼íŠ¸ ìì„¸ ìƒì„± (33ê°œ MediaPipe ëœë“œë§ˆí¬)"""
    squat_landmarks = [
        # ì–¼êµ´ ëœë“œë§ˆí¬ (0-10) - ìŠ¤ì¿¼íŠ¸ ì‹œ ë¨¸ë¦¬ê°€ ì•½ê°„ ì•„ë˜ë¡œ
        {"x": 0.5, "y": 0.25, "z": -0.1, "visibility": 0.99},  # 0: nose
        {"x": 0.51, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 1: left eye inner
        {"x": 0.52, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 2: left eye
        {"x": 0.53, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 3: left eye outer
        {"x": 0.49, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 4: right eye inner
        {"x": 0.48, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 5: right eye
        {"x": 0.47, "y": 0.24, "z": -0.1, "visibility": 0.99},  # 6: right eye outer
        {"x": 0.54, "y": 0.26, "z": -0.1, "visibility": 0.99},  # 7: left ear
        {"x": 0.46, "y": 0.26, "z": -0.1, "visibility": 0.99},  # 8: right ear
        {"x": 0.51, "y": 0.28, "z": -0.1, "visibility": 0.99},  # 9: mouth left
        {"x": 0.49, "y": 0.28, "z": -0.1, "visibility": 0.99},  # 10: mouth right
        
        # ëª¸í†µ ëœë“œë§ˆí¬ (11-24) - ìŠ¤ì¿¼íŠ¸ ì‹œ ìƒì²´ ì•½ê°„ ì•ìœ¼ë¡œ
        {"x": 0.4, "y": 0.4, "z": -0.1, "visibility": 0.99},   # 11: left shoulder
        {"x": 0.6, "y": 0.4, "z": -0.1, "visibility": 0.99},   # 12: right shoulder
        {"x": 0.32, "y": 0.55, "z": -0.1, "visibility": 0.99}, # 13: left elbow
        {"x": 0.68, "y": 0.55, "z": -0.1, "visibility": 0.99}, # 14: right elbow
        {"x": 0.25, "y": 0.7, "z": -0.1, "visibility": 0.99},  # 15: left wrist
        {"x": 0.75, "y": 0.7, "z": -0.1, "visibility": 0.99},  # 16: right wrist
        {"x": 0.23, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 17: left pinky
        {"x": 0.77, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 18: right pinky
        {"x": 0.23, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 19: left index
        {"x": 0.77, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 20: right index
        {"x": 0.23, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 21: left thumb
        {"x": 0.77, "y": 0.72, "z": -0.1, "visibility": 0.99}, # 22: right thumb
        {"x": 0.42, "y": 0.75, "z": -0.1, "visibility": 0.99}, # 23: left hip (ë‚®ì•„ì§)
        {"x": 0.58, "y": 0.75, "z": -0.1, "visibility": 0.99}, # 24: right hip (ë‚®ì•„ì§)
        
        # ë‹¤ë¦¬ ëœë“œë§ˆí¬ (25-32) - ë¬´ë¦ êµ½íˆê³  ë²Œì–´ì§
        {"x": 0.35, "y": 0.85, "z": -0.1, "visibility": 0.99}, # 25: left knee (ë²Œì–´ì§)
        {"x": 0.65, "y": 0.85, "z": -0.1, "visibility": 0.99}, # 26: right knee (ë²Œì–´ì§)
        {"x": 0.33, "y": 0.95, "z": -0.1, "visibility": 0.99}, # 27: left ankle
        {"x": 0.67, "y": 0.95, "z": -0.1, "visibility": 0.99}, # 28: right ankle
        {"x": 0.31, "y": 0.97, "z": -0.1, "visibility": 0.99}, # 29: left heel
        {"x": 0.69, "y": 0.97, "z": -0.1, "visibility": 0.99}, # 30: right heel
        {"x": 0.31, "y": 0.98, "z": -0.1, "visibility": 0.99}, # 31: left foot index
        {"x": 0.69, "y": 0.98, "z": -0.1, "visibility": 0.99}  # 32: right foot index
    ]
    return squat_landmarks

def generate_silhouette_from_guide_poses(
    guide_poses: List[Dict[str, Dict[str, float]]], 
    duration_seconds: int,
    intensity: str
) -> Dict:
    """
    guide_posesë¥¼ ê¸°ë°˜ìœ¼ë¡œ silhouette_animationì˜ keyframes ìƒì„±
    âœ… ìˆ˜ì •: ë””ë²„ê¹… ë¡œê·¸ ê°•í™” + ë¹ˆ ë°ì´í„° ê²€ì¦
    """
    print(f"\n{'='*60}")
    print(f"ğŸ¬ generate_silhouette_from_guide_poses í˜¸ì¶œ")
    print(f"  - guide_poses ê°œìˆ˜: {len(guide_poses) if guide_poses else 0}")
    print(f"  - duration_seconds: {duration_seconds}")
    print(f"  - intensity: {intensity}")
    
    if not guide_poses or len(guide_poses) == 0:
        print("âš ï¸ guide_posesê°€ ë¹„ì–´ìˆìŒ! ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ í¬ì¦ˆ ì‚¬ìš©")
        guide_poses = get_default_guide_poses_with_animation()
    
    if len(guide_poses) < 2:
        print(f"âš ï¸ guide_posesê°€ {len(guide_poses)}ê°œë¿! ìµœì†Œ 2ê°œ í•„ìš”. ê¸°ë³¸ í¬ì¦ˆ ì¶”ê°€")
        guide_poses = get_default_guide_poses_with_animation()
    
    speed_multiplier = get_speed_multiplier(intensity)
    base_cycle_time = 4.0 * speed_multiplier
    total_cycles = max(1, int(duration_seconds / base_cycle_time))
    time_per_pose = (base_cycle_time * 1000) / len(guide_poses)
    
    print(f"  - ì‚¬ì´í´ë‹¹ ì‹œê°„: {base_cycle_time:.2f}ì´ˆ")
    print(f"  - ì´ ì‚¬ì´í´: {total_cycles}íšŒ")
    print(f"  - í¬ì¦ˆë‹¹ ì‹œê°„: {time_per_pose:.0f}ms")
    
    keyframes = []
    current_time = 0
    
    for cycle in range(total_cycles):
        for i, guide_pose in enumerate(guide_poses):
            landmarks = convert_guide_pose_to_landmarks(guide_pose)
            
            keyframe = {
                "timestamp_ms": int(current_time),
                "pose_landmarks": landmarks,
                "description": f"ì‚¬ì´í´ {cycle+1}/{total_cycles} - í”„ë ˆì„ {i+1}/{len(guide_poses)}"
            }
            keyframes.append(keyframe)
            current_time += time_per_pose
    
    # ë§ˆì§€ë§‰ í”„ë ˆì„ ì¶”ê°€
    if guide_poses:
        keyframes.append({
            "timestamp_ms": int(current_time),
            "pose_landmarks": convert_guide_pose_to_landmarks(guide_poses[0]),
            "description": "ì¢…ë£Œ (ì‹œì‘ ìì„¸ë¡œ)"
        })
    
    print(f"âœ… ì´ {len(keyframes)}ê°œ í‚¤í”„ë ˆì„ ìƒì„± ì™„ë£Œ")
    print(f"{'='*60}\n")
    
    return {
        "fps": 30,
        "keyframes": keyframes
    }
async def generate_guide_poses(exercise_name: str) -> List[Dict[str, Dict[str, float]]]:
    """
    ìš´ë™ ì´ë¦„ ê¸°ë°˜ ê°€ì´ë“œ í¬ì¦ˆ ìƒì„±
    âœ… ìˆ˜ì •: ë°˜ë“œì‹œ 2ê°œ ì´ìƒì˜ í”„ë ˆì„ ë°˜í™˜ ë³´ì¥
    """
    exercise_name_lower = exercise_name.lower()
    
    print(f"ğŸ¯ generate_guide_poses í˜¸ì¶œ: '{exercise_name}'")
    
    # âœ… í•µì‹¬ ìš´ë™ í•˜ë“œì½”ë”©
    hardcoded_exercises = {
        "ìŠ¤ì¿¼íŠ¸": get_squat_guide_poses,
        "ëŸ°ì§€": get_lunge_guide_poses,
        "í”Œë­í¬": get_plank_guide_poses,
        "íŒ”êµ½í˜€í´ê¸°": get_pushup_guide_poses,
        "í‘¸ì‹œì—…": get_pushup_guide_poses,
    }
    
    # í•˜ë“œì½”ë”©ëœ ìš´ë™ ì²´í¬
    for keyword, pose_func in hardcoded_exercises.items():
        if keyword in exercise_name:
            poses = pose_func()
            print(f"âœ… í•˜ë“œì½”ë”© í¬ì¦ˆ ì‚¬ìš©: {keyword}, {len(poses)}ê°œ í”„ë ˆì„")
            return poses
    
    # âœ… íŠ¹ìˆ˜ ìš´ë™
    if "ì˜ì" in exercise_name or "ì•‰ì•„" in exercise_name:
        poses = get_sitting_guide_poses()
        print(f"âœ… ì•‰ì€ ìì„¸ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ëª©" in exercise_name or "ê²½ì¶”" in exercise_name:
        poses = get_neck_guide_poses()
        print(f"âœ… ëª© ìš´ë™ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ì†ëª©" in exercise_name:
        poses = get_wrist_guide_poses()
        print(f"âœ… ì†ëª© ìš´ë™ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ë°œëª©" in exercise_name:
        poses = get_ankle_guide_poses()
        print(f"âœ… ë°œëª© ìš´ë™ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ì–´ê¹¨" in exercise_name:
        poses = get_shoulder_guide_poses()
        print(f"âœ… ì–´ê¹¨ ìš´ë™ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "íŒ”" in exercise_name and ("ë²Œë¦¬ê¸°" in exercise_name or "ë“¤ê¸°" in exercise_name):
        poses = get_arm_raise_guide_poses()
        print(f"âœ… íŒ” ë“¤ê¸° í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ì¢…ì•„ë¦¬" in exercise_name or "ì¹´í”„" in exercise_name:
        poses = get_calf_raise_guide_poses()
        print(f"âœ… ì¢…ì•„ë¦¬ ìš´ë™ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ë ˆê·¸" in exercise_name and ("ë ˆì´ì¦ˆ" in exercise_name or "ì˜¬ë¦¬ê¸°" in exercise_name):
        poses = get_leg_raise_guide_poses()
        print(f"âœ… ë ˆê·¸ ë ˆì´ì¦ˆ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    elif "ìŠ¤íŠ¸ë ˆì¹­" in exercise_name or "ìŠ¤íŠ¸ë ˆì¹˜" in exercise_name:
        poses = get_stretching_guide_poses()
        print(f"âœ… ìŠ¤íŠ¸ë ˆì¹­ í¬ì¦ˆ ì‚¬ìš©: {len(poses)}ê°œ í”„ë ˆì„")
        return poses
    
    # âœ… AI ìƒì„± ì‹œë„
    print(f"ğŸ¤– AI í¬ì¦ˆ ìƒì„± ì‹œë„: {exercise_name}")
    ai_poses = await generate_poses_with_ai(exercise_name)
    
    if ai_poses and len(ai_poses) >= 2:
        print(f"âœ… AI í¬ì¦ˆ ìƒì„± ì„±ê³µ: {len(ai_poses)}ê°œ í”„ë ˆì„")
        return ai_poses
    else:
        print(f"âš ï¸ AI í¬ì¦ˆ ìƒì„± ì‹¤íŒ¨ ë˜ëŠ” í”„ë ˆì„ ë¶€ì¡±, ê¸°ë³¸ í¬ì¦ˆ ì‚¬ìš©")
        # âœ… ê¸°ë³¸ í¬ì¦ˆëŠ” ë°˜ë“œì‹œ 2ê°œ ì´ìƒ!
        default = get_default_guide_poses_with_animation()
        print(f"âœ… ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ í¬ì¦ˆ ì‚¬ìš©: {len(default)}ê°œ í”„ë ˆì„")
        return default


def convert_guide_pose_to_landmarks(guide_pose: Dict[str, Dict[str, float]]) -> List[Dict]:
    """guide_pose (ë”•ì…”ë„ˆë¦¬)ë¥¼ MediaPipe ëœë“œë§ˆí¬ ë¦¬ìŠ¤íŠ¸ (33ê°œ)ë¡œ ë³€í™˜"""
    landmarks = []
    for i in range(33):
        landmark_key = str(i)
        if landmark_key in guide_pose:
            pos = guide_pose[landmark_key]
            landmarks.append({
                "x": pos.get("x", 0.5),
                "y": pos.get("y", 0.5),
                "z": pos.get("z", 0),
                "visibility": 0.99
            })
        else:
            landmarks.append(interpolate_missing_landmark(i, guide_pose))
    return landmarks


def interpolate_missing_landmark(landmark_index: int, guide_pose: Dict[str, Dict[str, float]]) -> Dict:
    """guide_poseì— ì—†ëŠ” ëœë“œë§ˆí¬ë¥¼ ì£¼ë³€ ëœë“œë§ˆí¬ ê¸°ë°˜ìœ¼ë¡œ ë³´ê°„"""
    if 1 <= landmark_index <= 10:
        if "0" in guide_pose:
            nose = guide_pose["0"]
            offset_map = {
                1: {"x": 0.01, "y": -0.01}, 2: {"x": 0.02, "y": -0.01}, 3: {"x": 0.03, "y": -0.01},
                4: {"x": -0.01, "y": -0.01}, 5: {"x": -0.02, "y": -0.01}, 6: {"x": -0.03, "y": -0.01},
                7: {"x": 0.04, "y": 0.01}, 8: {"x": -0.04, "y": 0.01},
                9: {"x": 0.02, "y": 0.03}, 10: {"x": -0.02, "y": 0.03},
            }
            offset = offset_map.get(landmark_index, {"x": 0, "y": 0})
            return {"x": nose["x"] + offset["x"], "y": nose["y"] + offset["y"], "z": 0, "visibility": 0.99}
    
    if 17 <= landmark_index <= 22:
        wrist_key = "15" if landmark_index in [17, 19, 21] else "16"
        if wrist_key in guide_pose:
            wrist = guide_pose[wrist_key]
            finger_offset_map = {
                17: {"x": -0.02, "y": 0.02}, 18: {"x": 0.02, "y": 0.02},
                19: {"x": -0.04, "y": 0.01}, 20: {"x": 0.04, "y": 0.01},
                21: {"x": -0.01, "y": 0.03}, 22: {"x": 0.01, "y": 0.03},
            }
            offset = finger_offset_map.get(landmark_index, {"x": 0, "y": 0})
            return {"x": wrist["x"] + offset["x"], "y": wrist["y"] + offset["y"], "z": 0, "visibility": 0.99}
    
    if 29 <= landmark_index <= 32:
        ankle_key = "27" if landmark_index in [29, 31] else "28"
        if ankle_key in guide_pose:
            ankle = guide_pose[ankle_key]
            foot_offset_map = {
                29: {"x": -0.02, "y": 0.02}, 30: {"x": 0.02, "y": 0.02},
                31: {"x": -0.02, "y": 0.03}, 32: {"x": 0.02, "y": 0.03},
            }
            offset = foot_offset_map.get(landmark_index, {"x": 0, "y": 0})
            return {"x": ankle["x"] + offset["x"], "y": ankle["y"] + offset["y"], "z": 0, "visibility": 0.99}
    
    return {"x": 0.5, "y": 0.5, "z": 0, "visibility": 0.5}